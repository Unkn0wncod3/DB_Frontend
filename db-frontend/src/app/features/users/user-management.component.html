<section class="user-management">
  <header class="user-management__hero">
    <p class="user-management__eyebrow">{{ 'userManagement.eyebrow' | translate }}</p>
    <h1>{{ 'userManagement.title' | translate }}</h1>
    <p class="user-management__intro">{{ 'userManagement.subtitle' | translate }}</p>
  </header>

  <section *ngIf="errorMessage() as error" class="user-management__alert user-management__alert--error">
    <p>{{ error }}</p>
  </section>
  <section *ngIf="successMessage() as success" class="user-management__alert user-management__alert--success">
    <p>{{ success }}</p>
  </section>

  <form class="user-management__form" [formGroup]="createForm" (ngSubmit)="createUser()">
    <div>
      <label>{{ 'userManagement.form.username' | translate }}</label>
      <input type="text" formControlName="username" autocomplete="off" />
    </div>
    <div>
      <label>{{ 'userManagement.form.password' | translate }}</label>
      <input type="password" formControlName="password" autocomplete="new-password" />
    </div>
    <div>
      <label>{{ 'userManagement.form.role' | translate }}</label>
      <select formControlName="role">
        <option
          *ngFor="let role of roleOptions"
          [value]="role"
          [selected]="user.role === role"
          [disabled]="!canSelectRoleOption(role)"
        >
          {{ roleLabel(role) }}
        </option>
      </select>
    </div>
    <div>
      <label>{{ 'userManagement.form.profilePictureUrl' | translate }}</label>
      <input
        type="url"
        formControlName="profile_picture_url"
        [placeholder]="'userManagement.form.profilePicturePlaceholder' | translate"
      />
    </div>
    <div class="user-management__form-action">
      <button
        type="submit"
        class="user-management__primary-button"
        [class.user-management__primary-button--disabled]="createForm.invalid || isCreating()"
        [disabled]="createForm.invalid || isCreating()"
      >
        <span *ngIf="isCreating(); else createLabel">{{ 'userManagement.actions.creating' | translate }}</span>
        <ng-template #createLabel>{{ 'userManagement.actions.create' | translate }}</ng-template>
      </button>
      <p
        class="user-management__helper"
        [class.user-management__helper--visible]="createForm.invalid && (createForm.touched || createForm.dirty)"
      >
        {{ 'userManagement.form.validationHint' | translate }}
      </p>
    </div>
  </form>

  <section class="user-management__list">
    <div class="user-management__list-header">
      <h2>{{ 'userManagement.list.title' | translate }}</h2>
      <button type="button" class="user-management__refresh" (click)="refresh()" [disabled]="isLoading()">
        <svg viewBox="0 0 24 24" aria-hidden="true" [class.is-spinning]="isLoading()">
          <path
            d="M4 4v6h1.5V6.62A7.5 7.5 0 1 1 3 12h-1.5A9 9 0 1 0 4 4Zm0 0"
            fill="none"
            stroke="currentColor"
            stroke-width="1.5"
            stroke-linecap="round"
            stroke-linejoin="round"
          />
        </svg>
        <span *ngIf="isLoading(); else refreshLabel">{{ 'userManagement.actions.refreshing' | translate }}</span>
        <ng-template #refreshLabel>{{ 'userManagement.actions.refresh' | translate }}</ng-template>
      </button>
    </div>
    <table *ngIf="users().length > 0; else emptyState">
      <thead>
        <tr>
          <th>{{ 'userManagement.table.username' | translate }}</th>
          <th>{{ 'userManagement.table.profilePicture' | translate }}</th>
          <th>{{ 'userManagement.table.preferences' | translate }}</th>
          <th>{{ 'userManagement.table.role' | translate }}</th>
          <th>{{ 'userManagement.table.status' | translate }}</th>
          <th>{{ 'userManagement.table.created' | translate }}</th>
          <th class="user-management__table-actions">{{ 'userManagement.table.actions' | translate }}</th>
        </tr>
      </thead>
      <tbody>
        <tr *ngFor="let user of users(); trackBy: trackByUser">
          <td>{{ user.username }}</td>
          <td class="user-management__avatar-cell">
            <img *ngIf="user.profile_picture_url; else noAvatar" [src]="user.profile_picture_url" [alt]="user.username" />
            <ng-template #noAvatar>&mdash;</ng-template>
          </td>
          <td class="user-management__preferences-cell">
            <button type="button" class="user-management__preferences-button" (click)="openPreferences(user)" [disabled]="!user.preferences">
              {{ 'userManagement.table.preferencesButton' | translate }}
            </button>
          </td>
          <td class="user-management__role-cell">
            <select
              #roleSelect
              [value]="user.role"
              (change)="onRoleChange(user, roleSelect.value)"
              [disabled]="!canEditUserRole(user) || roleUpdatingId() === user.id"
            >
              <option
                *ngFor="let role of roleOptions"
                [value]="role"
                [disabled]="!canSelectRoleOption(role)"
              >
                {{ roleLabel(role) }}
              </option>
            </select>
            <span *ngIf="roleUpdatingId() === user.id" class="user-management__role-spinner">
              {{ 'userManagement.status.updating' | translate }}
            </span>
          </td>
          <td>
            <span class="user-management__badge" [class.user-management__badge--inactive]="!user.is_active">
              {{ user.is_active ? ('userManagement.status.active' | translate) : ('userManagement.status.inactive' | translate) }}
            </span>
          </td>
          <td>{{ user.created_at ? (user.created_at | date:'dd/MM/yyyy, HH:mm') : '\u2013' }}</td>
          <td class="user-management__table-actions">
            <button
              type="button"
              class="danger"
              [class.danger--disabled]="isProtectedAccount(user) || isCurrentUser(user)"
              [disabled]="isProtectedAccount(user) || isCurrentUser(user)"
              (click)="requestDeletion(user)"
            >
              <ng-container *ngIf="isProtectedAccount(user); else deleteLabel">
                {{ 'userManagement.actions.locked' | translate }}
              </ng-container>
              <ng-template #deleteLabel>{{ 'userManagement.actions.delete' | translate }}</ng-template>
            </button>
          </td>
        </tr>
      </tbody>
    </table>
    <ng-template #emptyState>
      <p class="user-management__empty">
        {{ isLoading() ? ('userManagement.list.loading' | translate) : ('userManagement.list.empty' | translate) }}
      </p>
    </ng-template>
    <p class="user-management__note">
      {{ 'userManagement.list.protectedHint' | translate:{ username: protectedUsername } }}
    </p>
  </section>

  <div class="user-management__modal" *ngIf="viewingPreferences() as prefUser">
    <div class="user-management__modal-backdrop" (click)="closePreferences()"></div>
    <div class="user-management__modal-dialog" role="dialog" aria-modal="true" aria-live="assertive">
      <ng-container *ngIf="preferencesSummary(prefUser) as prefs">
        <h3>{{ 'userManagement.preferences.title' | translate:{ username: prefUser.username } }}</h3>
        <dl class="user-management__preferences-list">
          <div>
            <dt>{{ 'profile.preferences.theme.label' | translate }}</dt>
            <dd>{{ ('profile.preferences.theme.' + prefs.theme) | translate }}</dd>
          </div>
          <div>
            <dt>{{ 'profile.preferences.language.label' | translate }}</dt>
            <dd>{{ ('profile.preferences.language.' + prefs.language) | translate }}</dd>
          </div>
          <div>
            <dt>{{ 'profile.preferences.notifications.label' | translate }}</dt>
            <dd>
              <span class="user-management__pref-chip" [class.user-management__pref-chip--active]="prefs.notifications.email">
                {{ 'profile.preferences.notifications.email' | translate }}
              </span>
              <span class="user-management__pref-chip" [class.user-management__pref-chip--active]="prefs.notifications.push">
                {{ 'profile.preferences.notifications.push' | translate }}
              </span>
            </dd>
          </div>
        </dl>
        <div class="user-management__modal-actions">
          <button type="button" class="ghost" (click)="closePreferences()">
            {{ 'userManagement.actions.close' | translate }}
          </button>
        </div>
      </ng-container>
    </div>
  </div>

  <div class="user-management__modal" *ngIf="pendingDeletion() as account">
    <div class="user-management__modal-backdrop" (click)="cancelDeletion()"></div>
    <div class="user-management__modal-dialog" role="dialog" aria-modal="true" aria-live="assertive">
      <h3>{{ 'userManagement.modal.title' | translate }}</h3>
      <p>{{ 'userManagement.modal.body' | translate:{ username: account.username } }}</p>
      <div class="user-management__modal-actions">
        <button type="button" class="ghost" (click)="cancelDeletion()" [disabled]="isDeleting()">
          {{ 'userManagement.actions.cancel' | translate }}
        </button>
        <button type="button" class="danger" (click)="confirmDeletion()" [disabled]="isDeleting()">
          <span *ngIf="isDeleting(); else confirmLabel">{{ 'userManagement.actions.deleting' | translate }}</span>
          <ng-template #confirmLabel>{{ 'userManagement.actions.confirmDeleteCta' | translate }}</ng-template>
        </button>
      </div>
    </div>
  </div>
</section>
