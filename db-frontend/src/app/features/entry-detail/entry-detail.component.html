<section class="entry-detail">
  <header class="entry-detail__header">
    <div class="entry-detail__title">
      <a routerLink="/" class="entry-detail__back">{{ 'entryDetail.actions.back' | translate }}</a>
      <h1>{{ 'entryDetail.title' | translate:{ value: entryTitle() ?? (entryId ?? ('entryDetail.labels.unknownId' | translate)) } }}</h1>
      <p *ngIf="entryType || entryId">
        <span *ngIf="entryType">{{ 'entryDetail.labels.type' | translate:{ type: entryType } }}</span>
        <span *ngIf="entryType && entryId" aria-hidden="true">&nbsp;&middot;&nbsp;</span>
        <span *ngIf="entryId">{{ 'entryDetail.labels.id' | translate:{ id: entryId } }}</span>
      </p>
    </div>
    <div class="entry-detail__actions">
      <button type="button" class="entry-detail__refresh" (click)="refresh()" [disabled]="isLoading() || isSaving()">
        <span *ngIf="isLoading(); else refreshLabel">{{ 'entryDetail.status.loading' | translate }}</span>
        <ng-template #refreshLabel>{{ 'entryDetail.actions.refresh' | translate }}</ng-template>
      </button>
      <button type="submit" form="entryDetailForm" class="entry-detail__save" [disabled]="!hasChanges() || isSaving()">
        <span *ngIf="isSaving(); else saveLabel">{{ 'entryDetail.status.saving' | translate }}</span>
        <ng-template #saveLabel>{{ 'entryDetail.actions.save' | translate }}</ng-template>
      </button>
      <button type="button" class="entry-detail__delete" (click)="openDeleteDialog()" [disabled]="isDeleting()">
        <span *ngIf="isDeleting(); else deleteLabel">{{ 'entryDetail.status.deleting' | translate }}</span>
        <ng-template #deleteLabel>{{ 'entryDetail.actions.delete' | translate }}</ng-template>
      </button>
    </div>
  </header>

  <section *ngIf="errorMessage() as error" class="entry-detail__alert entry-detail__alert--error">
    <p>{{ error }}</p>
  </section>

  <section *ngIf="successMessage() as success" class="entry-detail__alert entry-detail__alert--success">
    <p>{{ success }}</p>
  </section>

  <div class="entry-detail__content" *ngIf="entry() as record">
    <form
      id="entryDetailForm"
      class="entry-detail__form"
      [formGroup]="form"
      (ngSubmit)="save()"
    >
      <app-entry-detail-field-grid
        [form]="form"
        [fields]="fields()"
        [booleanOptions]="booleanOptions()"
      ></app-entry-detail-field-grid>
    </form>

    <aside class="entry-detail__relations" *ngIf="showPersonRelations()">
      <header>
        <h2>{{ entryTitle() ?? ('entryDetail.labels.relationships' | translate) }}</h2>
        <p>{{ 'entryDetail.labels.connectedItems' | translate }}</p>
      </header>

      <section *ngIf="relationsError() as relError" class="entry-detail__alert entry-detail__alert--error">
        <p>{{ relError }}</p>
      </section>

      <section *ngIf="isRelationsLoading()" class="entry-detail__relations-state">
        <p>{{ 'entryDetail.status.loadingRelations' | translate }}</p>
      </section>

      <section *ngIf="!isRelationsLoading() && !hasRelations()" class="entry-detail__relations-state">
        <p>{{ 'entryDetail.status.noRelations' | translate }}</p>
      </section>

      <section *ngIf="showPersonRelations()" class="entry-detail__relations-group">
        <div class="entry-detail__relations-heading">
          <h3>{{ 'entryDetail.relations.profiles' | translate }}</h3>
          <a [routerLink]="relationListLink('profiles')">{{ 'entryDetail.relations.viewAll' | translate }}</a>
        </div>
        <form class="entry-detail__profile-link" [formGroup]="profileLinkForm" (ngSubmit)="linkProfile()">
          <label>
            <span>{{ 'entryDetail.relations.profileIdLabel' | translate }}</span>
            <input type="number" formControlName="profileId" placeholder="42" />
          </label>
          <label>
            <span>{{ 'entryDetail.relations.profileNoteLabel' | translate }}</span>
            <input type="text" formControlName="note" [placeholder]="'entryDetail.relations.profileNotePlaceholder' | translate" />
          </label>
          <div class="entry-detail__profile-link-actions">
            <p *ngIf="profileLinkError() as linkError" class="entry-detail__profile-link-error">{{ linkError }}</p>
            <button type="submit" [disabled]="isManagingProfileLinks()">
              {{ 'entryDetail.relations.linkProfile' | translate }}
            </button>
          </div>
        </form>
        <ul *ngIf="relatedProfiles().length > 0; else noProfiles">
          <li *ngFor="let profile of relatedProfiles(); trackBy: trackByRelation">
            <a *ngIf="profile.routerLink; else profileStatic" [routerLink]="profile.routerLink">
              <strong>{{ profile.label }}</strong>
              <span>{{ profile.description }}</span>
            </a>
            <ng-template #profileStatic>
              <div>
                <strong>{{ profile.label }}</strong>
                <span>{{ profile.description }}</span>
              </div>
            </ng-template>
            <button
              type="button"
              class="entry-detail__relation-unlink"
              (click)="unlinkProfile(profile.id)"
              [disabled]="isManagingProfileLinks()"
            >
              {{ 'entryDetail.relations.unlinkProfile' | translate }}
            </button>
          </li>
        </ul>
        <ng-template #noProfiles>
          <p class="entry-detail__relations-state">
            {{ 'entryDetail.status.noRelations' | translate }}
          </p>
        </ng-template>
      </section>

      <section *ngIf="relatedNotes().length > 0" class="entry-detail__relations-group">
        <div class="entry-detail__relations-heading">
          <h3>{{ 'entryDetail.relations.notes' | translate }}</h3>
          <a [routerLink]="relationListLink('notes')">{{ 'entryDetail.relations.viewAll' | translate }}</a>
        </div>
        <ul>
          <li *ngFor="let note of relatedNotes(); trackBy: trackByRelation">
            <a *ngIf="note.routerLink; else noteStatic" [routerLink]="note.routerLink">
              <strong>{{ note.label }}</strong>
              <span>{{ note.description }}</span>
              <small *ngIf="note.timestamp">{{ note.timestamp | date:'dd/MM/yyyy, HH:mm' }}</small>
            </a>
            <ng-template #noteStatic>
              <div>
                <strong>{{ note.label }}</strong>
                <span>{{ note.description }}</span>
                <small *ngIf="note.timestamp">{{ note.timestamp | date:'dd/MM/yyyy, HH:mm' }}</small>
              </div>
            </ng-template>
          </li>
        </ul>
      </section>

      <section *ngIf="relatedActivities().length > 0" class="entry-detail__relations-group">
        <div class="entry-detail__relations-heading">
          <h3>{{ 'entryDetail.relations.activities' | translate }}</h3>
          <a [routerLink]="relationListLink('activities')">{{ 'entryDetail.relations.viewAll' | translate }}</a>
        </div>
        <ul>
          <li *ngFor="let activity of relatedActivities(); trackBy: trackByRelation">
            <a *ngIf="activity.routerLink; else activityStatic" [routerLink]="activity.routerLink">
              <strong>{{ activity.label }}</strong>
              <span>{{ activity.description }}</span>
              <small *ngIf="activity.timestamp">{{ activity.timestamp | date:'dd/MM/yyyy, HH:mm' }}</small>
            </a>
            <ng-template #activityStatic>
              <div>
                <strong>{{ activity.label }}</strong>
                <span>{{ activity.description }}</span>
                <small *ngIf="activity.timestamp">{{ activity.timestamp | date:'dd/MM/yyyy, HH:mm' }}</small>
              </div>
            </ng-template>
          </li>
        </ul>
      </section>
    </aside>
  </div>

  <section *ngIf="!entry() && !isLoading()" class="entry-detail__state">
    <p>{{ 'entryDetail.status.empty' | translate }}</p>
  </section>

  <section *ngIf="entry() as raw" class="entry-detail__raw">
    <h2>{{ 'entryDetail.sections.raw' | translate }}</h2>
    <pre>{{ raw | json }}</pre>
  </section>

  <div class="entry-detail__modal-backdrop" *ngIf="isDeleteDialogOpen()">
    <div class="entry-detail__modal">
      <h2>{{ 'entryDetail.delete.dialogTitle' | translate }}</h2>
      <p>{{ 'entryDetail.delete.confirm' | translate }}</p>
      <label class="entry-detail__modal-field">
        <span>{{ 'entryDetail.delete.passcodeLabel' | translate }}</span>
        <input
          #deletePasscodeInput
          type="password"
          [value]="deletePasscode()"
          (input)="onDeletePasscodeChange(deletePasscodeInput.value)"
          [placeholder]="'entryDetail.delete.passcodePlaceholder' | translate"
          [disabled]="isDeleting()"
        />
      </label>
      <p class="entry-detail__modal-error" *ngIf="deleteDialogError()">{{ deleteDialogError() }}</p>
      <div class="entry-detail__modal-actions">
        <button type="button" class="entry-detail__delete" (click)="confirmDelete()" [disabled]="!canConfirmDelete()">
          <span *ngIf="isDeleting(); else modalDeleteLabel">{{ 'entryDetail.status.deleting' | translate }}</span>
          <ng-template #modalDeleteLabel>{{ 'entryDetail.delete.confirmButton' | translate }}</ng-template>
        </button>
        <button type="button" class="entry-detail__modal-cancel" (click)="closeDeleteDialog()" [disabled]="isDeleting()">
          {{ 'entryDetail.delete.cancelButton' | translate }}
        </button>
      </div>
    </div>
  </div>
</section>
