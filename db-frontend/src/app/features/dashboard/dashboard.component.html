<section class="dashboard">
  <header class="dashboard__header">
    <div>
      <h1>{{ 'dashboard.title' | translate }}</h1>
      <p>{{ 'dashboard.subtitle' | translate }}</p>
    </div>
    <div class="dashboard__actions">
      <button type="button" class="dashboard__refresh" (click)="forceRefresh()" [disabled]="isLoading()">
        <span *ngIf="isLoading(); else idleState">{{ 'dashboard.actions.refreshing' | translate }}</span>
        <ng-template #idleState>{{ 'dashboard.actions.refresh' | translate }}</ng-template>
      </button>
      <span class="dashboard__meta" *ngIf="lastUpdated() as timestamp">
        {{ 'dashboard.meta.lastUpdated' | translate:{ value: (timestamp | date:'short') } }}
      </span>
    </div>
  </header>

  <section *ngIf="errorMessage() as error" class="dashboard__error">
    <p>{{ error }}</p>
  </section>

  <section *ngIf="overview() && totalCards().length === 0 && activityCards().length === 0 && !hasRecentItems()" class="dashboard__panel dashboard__panel--empty">
    <p>{{ 'dashboard.status.emptyState' | translate }}</p>
    <pre class="dashboard__raw" *ngIf="overview() as raw">{{ raw | json }}</pre>
  </section>

  <section *ngIf="totalCards().length > 0" class="dashboard__grid">
    <article *ngFor="let card of totalCards(); trackBy: trackByKey" class="dashboard__card dashboard__card--highlight">
      <h2>{{ card.label }}</h2>
      <p class="dashboard__value">{{ card.value | number }}</p>
    </article>
  </section>

  <section *ngIf="activityCards().length > 0" class="dashboard__panel">
    <header>
      <h2>{{ 'dashboard.sections.activity' | translate }}</h2>
    </header>
    <ul>
      <li *ngFor="let item of activityCards(); trackBy: trackByKey">
        <span>{{ item.label }}</span>
        <strong>{{ item.value | number }}</strong>
      </li>
    </ul>
  </section>

  <section *ngIf="overview()?.latest as latest" class="dashboard__panel">
    <header>
      <h2>{{ 'dashboard.sections.latest' | translate }}</h2>
    </header>
    <div class="dashboard__latest">
      <article class="dashboard__latest-item">
        <h3>{{ 'dashboard.latest.created.title' | translate }}</h3>
        <ng-container *ngIf="resolveLatestRecord(latest.created, 'created') as createdRecord; else createdFallback">
          <ng-container *ngIf="entryLink(createdRecord) as createdLink; else createdStatic">
            <a
              [routerLink]="createdLink"
              class="dashboard__latest-entry dashboard__latest-entry--link"
            >
              <ng-container *ngTemplateOutlet="latestEntry; context: { $implicit: createdRecord, kind: 'created', fallback: 'dashboard.labels.noRecentCreate', tsKey: 'dashboard.latest.created.timestamp' }"></ng-container>
            </a>
          </ng-container>
          <ng-template #createdStatic>
            <div class="dashboard__latest-entry">
              <ng-container *ngTemplateOutlet="latestEntry; context: { $implicit: createdRecord, kind: 'created', fallback: 'dashboard.labels.noRecentCreate', tsKey: 'dashboard.latest.created.timestamp' }"></ng-container>
            </div>
          </ng-template>
        </ng-container>
        <ng-template #createdFallback>
          <p class="dashboard__latest-empty">{{ 'dashboard.labels.noRecentCreate' | translate }}</p>
        </ng-template>
      </article>
      <article class="dashboard__latest-item">
        <h3>{{ 'dashboard.latest.updated.title' | translate }}</h3>
        <ng-container *ngIf="resolveLatestRecord(latest.updated, 'updated') as updatedRecord; else updatedFallback">
          <ng-container *ngIf="entryLink(updatedRecord) as updatedLink; else updatedStatic">
            <a
              [routerLink]="updatedLink"
              class="dashboard__latest-entry dashboard__latest-entry--link"
            >
              <ng-container *ngTemplateOutlet="latestEntry; context: { $implicit: updatedRecord, kind: 'updated', fallback: 'dashboard.labels.noRecentUpdate', tsKey: 'dashboard.latest.updated.timestamp' }"></ng-container>
            </a>
          </ng-container>
          <ng-template #updatedStatic>
            <div class="dashboard__latest-entry">
              <ng-container *ngTemplateOutlet="latestEntry; context: { $implicit: updatedRecord, kind: 'updated', fallback: 'dashboard.labels.noRecentUpdate', tsKey: 'dashboard.latest.updated.timestamp' }"></ng-container>
            </div>
          </ng-template>
        </ng-container>
        <ng-template #updatedFallback>
          <p class="dashboard__latest-empty">{{ 'dashboard.labels.noRecentUpdate' | translate }}</p>
        </ng-template>
      </article>
    </div>
    <ng-template #latestEntry let-record let-kind="kind" let-fallback="fallback" let-tsKey="tsKey">
      <strong class="dashboard__latest-name">{{ formatRecordLabel(record, fallback) }}</strong>
      <p *ngIf="formatRecordType(record) as recordType" class="dashboard__recent-meta">
        {{ recordType }}
      </p>
      <p *ngIf="formatRecordTimestampFor(record, kind) as ts" class="dashboard__recent-meta">
        {{ tsKey | translate:{ value: (ts | date:'short') } }}
      </p>
    </ng-template>
  </section>

  <section class="dashboard__panel" *ngIf="hasRecentItems(); else noRecent">
    <header>
      <h2>{{ 'dashboard.sections.recent' | translate }}</h2>
    </header>
    <ul class="dashboard__recent-list">
      <li
        *ngFor="let item of overview()?.recent ?? []; trackBy: trackByRecord"
        class="dashboard__recent-item"
        [class.dashboard__recent-item--link]="!!entryLink(item)"
      >
        <a
          *ngIf="entryLink(item) as link; else recentStatic"
          [routerLink]="link"
          class="dashboard__recent-link"
        >
          <ng-container *ngTemplateOutlet="recentRecord; context: { $implicit: item }"></ng-container>
        </a>
        <ng-template #recentStatic>
          <ng-container *ngTemplateOutlet="recentRecord; context: { $implicit: item }"></ng-container>
        </ng-template>
      </li>
    </ul>
    <ng-template #recentRecord let-record>
      <div class="dashboard__recent-content">
        <strong>{{ formatRecordLabel(record, 'dashboard.labels.unknownEntry') }}</strong>
        <p *ngIf="formatRecordMeta(record) as itemMeta" class="dashboard__recent-meta">
          {{ itemMeta }}
        </p>
      </div>
      <time *ngIf="formatRecordTimestamp(record) as ts">{{ ts | date:'short' }}</time>
    </ng-template>
  </section>
  <ng-template #noRecent>
    <section class="dashboard__panel dashboard__panel--empty">
      <p>{{ 'dashboard.status.noRecent' | translate }}</p>
    </section>
  </ng-template>
</section>

